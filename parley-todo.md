## Actually actionable list
- [ ] Implement vertical alignment in Parley. Then we can just use a regular InlineBox to implement first_row_min_height and leading_space
- [ ] Figure out what to do for the tab character. My swash changes alone don't fix it, and it may be best to just wait for parley to switch to harfruzz
- [ ] Land a "font size multiplier" in Parley to implement FontTweak::scale
- [ ] Find a better way to expose AccessKit from Parley that doesn't require so many hacks
- [ ] Add a Parley API for using *full* style objects in RangedBuilder instead of having to set one property at a time
- [ ] Figure out the best way to implement "newlines don't actually create a new line"
  - If Parley exposes a lower-level line-by-line API, we can just lay out the lines horizontally instead of vertically
  - If Parley can shape text based on a character iterator instead of a string, we can map newlines to spaces without having to allocate an entire string

## Parley:
- [x] Text wrap styling (https://github.com/linebender/parley/pull/315)
- [x] Text truncation with ellipsis
- [ ] serde support for some types (the selection ones at least)
- [ ] Vertical alignment options, especially for InlineBox (https://github.com/linebender/parley/issues/291)
- [ ] Ability to set line.offset (necessary for LayoutSection::leading_space)
  - [ ] This can't just be a visual thing because of hit testing; Layout needs to agree on where everything is
- [x] Absolute line height
- [x] Custom family names (https://github.com/linebender/parley/issues/117)
- [x] Inline box fix (https://github.com/linebender/parley/pull/299)
- [x] Don't round vertical metrics (https://github.com/linebender/parley/pull/297)
- [x] RTL jank (https://github.com/linebender/parley/issues/298)
- [ ] Support the tab character (https://github.com/linebender/parley/issues/302)
- [ ] AccessKit improvements (https://github.com/linebender/parley/issues/310)
- [ ] Not Parley, but Swash: tighter glyph bounds (https://github.com/dfrg/zeno/pull/15)
- [ ] SystemUi doesn't properly fallback in some cases (e.g. Arabic text, macOS shortcut symbols) on my machine; SansSerif does (https://github.com/linebender/parley/issues/323)

## Here:
- [ ] Text layout
  - [x] Sometimes when resizing the Font Book window, the text doesn't wrap properly (fixed)
    - ~~Only happens when the mouse is held down~~
    - ~~Could it be trailing whitespace?~~
  - [ ] In the EasyMark example, with the text "There is no alternative way to specify the strong style", at certain wrap widths, the text from "strong" onwards will be shifted down 1px
  - [ ] With the fancy variable autohinted Ubuntu font, *sometimes* the "Interactive Container" label on the right demos bar appears improperly wrapped?
  - [x] With "Text Wrap Mode" set to "Some(Wrap)" or "Some(Truncate)" in the Settings window, labels are not as wide as they should be compared to master branch (see Text Layout window)
  - [x] Text wrapping
    - [x] max_rows
    - [x] break_anywhere
    - [x] overflow_character
  - [x] `LayoutJob::round_output_to_gui`
  - [ ] `LayoutJob::break_on_newline`
  - [ ] RTL considerations
    - [ ] Label wrapping only occurs in LTR layouts, but make sure it doesn't do anything weird with RTL labels
    - [ ] Do label wrapping in RTL too?
    - [x] Text is right-justified if a label is split in the middle of RTL text, or if a line contains only an RTL label
      - This may be desirable behavior, but is weird
      - Whoops; we asked Parley for RTL-aware behavior and got it
    - [ ] overflow_character should appear at the "start" of the line for RTL text
    - [ ] RTL support for `egui::Align`
  - [ ] Once Parley has vertical alignment, remove the hack for leading_space/first_row_min_height
  - [ ] Align multiple consecutive labels to the same baseline, even with different fonts
  - [x] Line height discrepancy between old and new layout (Parley line height is just the font size)
- [ ] Text rendering
  - [x] Investigate whether swash is being too conservative with its shape bounds and cutting off rendered glyphs
    - The reverse is true https://github.com/dfrg/zeno/pull/15
  - [x] We don't need to do all the weird DPI stuff now, probably
    - [x] (see https://github.com/emilk/egui/issues/3664 for an example of the hacks we can get rid of)
  - [ ] A bunch of font atlas stuff
    - [ ] Use etagere instead of rolling our own atlas?
      - guillotiere did well in synthetic testing but seemed to fall over when I tried it here; revisit?
      - This requires multiple texture sampler support in the backends. This can be done another time
      - [ ] If using etagere or guillotiere, allow reclaiming unused glyphs
    - [ ] Properly handle the atlas overflowing during layout instead of trying to predict it ahead of time
  - [x] Colored emoji
    - [x] Alpha is a bit messed up, probably due to sRGB not un-multiplying and re-multiplying the alpha
      - ~~Probably~~ fixed in https://github.com/emilk/egui/pull/5824
  - [x] When zooming in and out, there are these one-frame glitches where the wrong texture coordinates are used for the glyphs
    - Once again, confirm that this is a regression and not an existing bug
    - Forgot to clear the glyph atlas
- [ ] Text selection and editing
  - [x] Unify the three different cursor types and move to a Parley-like API before moving to the actual Parley API (done)
  - [x] Rewrite selection code to use parley's API
    - [x] Basic API mapping (done)
    - [x] Selection painting (done but kinda janky)
    - [x] Probably rework label_text_selection (does it take bidirectional text into account?)
      - [x] Still some jank when the cursor is kinda below the first label and it selects the "rest of the line" (fixed)
      - [x] Make it support bidirectional text (fun!)
        - I think this... just works already?
    - [x] finish the gnarly parts that i've been putting off
      - [x] indentation (done, but untested because parley's tab character support is broken)
      - [x] selecting a range without having a Galley rendered already (done)
    - [x] Fully remove CCursor and CCursorRange
  - [x] Support `char_limit` (done but untested)
  - [x] AccessKit integration(?) (done; kinda janky and cannot currently test whether the bounding boxes are correct)
  - [x] Remove RowVertexIndices from selection painting
  - [ ] Do another pass over TextBuffer's API
  - [ ] Test IME support
  - [ ] Smoothe out AccessKit API integration (and reduce temp allocations)
  - [ ] Test AccessKit text bounding boxes (horiz_offset for alignment and vertical_offset for wrapped labels working)
  - [ ] Character-based cursors could never be in an invalid state; byte-based cursors can. Ensure we don't try to slice a string using any non-validated selections
- [ ] Text styling
  - [x] Fix FontDefinitions and adding fonts
    - [x] Get fallback/ordering working properly
      - I think this is done?
  - [x] Auto fallback to faux italics (and perhaps faux bold)
    - [x] run.synthesis()
    - Faux bold doesn't work because Parley always tries to embolden Ubuntu Light because we ask for Ubuntu Regular
  - [ ] Actually render text decorations (underline, strikethrough, etc) and backgrounds
    - [x] Strikethrough and underline
      - [x] Feathered
    - [x] Backgrounds
    - [x] valign ~~(this will take a lot of implementing in Parley)~~
    - [x] Families and not just files
    - [x] Option to load system fonts in FontDefinitions
  - [ ] FontTweak is very not-implemented
    - [ ] scale
      - This actually *does* affect layout, but only horizontally. Not sure if this is implementable.
    - [x] y_offset_factor
    - [x] y_offset
    - [ ] baseline_offset_factor
      - What does this even do?
  - [x] Can we do bold now?
  - [x] Letter spacing
    - Why was this here? It's been implemented for a while
  - [x] Hinting enable/disable
    - [x] Maybe a global setting and also an override in FontTweak?
  - [ ] If file size isn't an issue, ship variable fonts in epaint-default-fonts
  - [x] Make sure to test with syntect disabled (there's some old style-heavy code that is cfg'd out with syntect enabled)
  - [ ] Smoothe out the janky parts of the new API
    - [ ] For mixed-DPI purposes, and because we don't need to store the FontStore as a mutex, ctx.fonts() now returns a "fonts view" that's technically read/write. But there are no operations that *semantically* modify the fonts from it
    - [ ] FontStore and Fonts are different and we should just expose them separately instead of passing through all the FontStore methods onto Fonts
  - [x] Work around https://github.com/jslegers/emoji-icon-font/issues/18 / https://github.com/emilk/egui/issues/1284
  - [ ] Ship a newer revision of the Ubuntu font? The hinting on the current one is kinda distracting
  - [ ] https://github.com/emilk/egui/pull/5979/files great, now we have two different implementations of system font scanning
    - https://github.com/linebender/resvg/issues/862
- [x] Cross-cutting concerns
  - [x] Actually remove all the ab_glyph stuff
    - Sayonara, ab_glyph ðŸ«¡
- [ ] Perf optimizations!
  - [ ] Stop using TreeBuilder so we don't have to allocate a bunch of strings
  - [ ] https://github.com/emilk/egui/issues/1098
  - [ ] Line-level layout memoization (https://github.com/emilk/egui/pull/5411)
- [ ] The other 90%
  - [ ] Comment the new code better
  - [ ] update All Of The Doctests...
  - [ ] Go over APIs and clean them up
  - [ ] New documentation for the new APIs
  - [ ] Make sure everything's landed in Parley
  - [ ] Migration guide for the release notes
- [ ] Deferred to the future
  - [ ] Multiple (and smaller) text atlases
    - [ ] Use monochrome texture for font atlas (R8 format)
      - [ ] Does the current one only use RGBA so we can use the same shader for everything?
      - [ ] Probably needs support in the backends for mask-only textures (gl.ALPHA and whatever the wgpu equivalent is)
      - [ ] Have separate atlases for color emoji and glyphs/discs
    - [ ] Multiple texture sampler support in all the backends
    - [ ] Automatically switch between multiple atlases if one isn't enough
  - [ ] Better (more CSSish) font API
    - [ ] Revamp TextFormat in general
      - [ ] Can it cascade?
  - [ ] Drawing really really big glyphs causes a panic because the atlas can't allocate enough space
  - [ ] Allow modifying text without doing a relayout afterwards (or at least not a full one)
    - [ ] The original TextEdit code had a relayout too
  - [ ] Per-viewport pixels_per_point seems to not be taken into account when calculating cursor positions for selections
    - Not a new issue
  - [ ] If you really scrunch up the "Code Example" window, it'll wrap while the cursor is held
    - This is an issue in the non-Parley branch too, but only at >1x zoom
  - [ ] If you select the text overflow character, the "logical selection" should extend to the end of the text.
  - [ ] Text overflow character should use the style at the end of the line it replaces, but we have no way to get that without redoing the *entire* layout
  - [ ] Unify the behavior of `Context::set_fonts` and `Context::add_font` wrt equality checking (or just don't do it, and unconditionally set fonts)
